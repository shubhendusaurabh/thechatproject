extends layout

style
    #remoteVideo video
        height: 150px

    #localVideo
        height: 150px


block mainContent
    div.container

        form#createRoom
            input#sessionInput
            button(type=submit, class=btn) Submit

        video#localVideo
        div#remoteVideo

        script(src="http://simplewebrtc.com/latest.js")

        script.
            var peer = location.search && location.search.split('?')[1];

            var webrtc = new SimpleWebRTC({
                localVideoEl: 'localVideo',
                remoteVideoEl: 'remoteVideo',
                autoRequestMedia: true,
                debug: true
            });

            webrtc.on('readyToCall', function() {
                if (room) webrtc.joinRoom(room);
            });

            webrtc.on('videoAdded', function(video, peer) {
                console.log('video added', peer);
                var remotes = document.getElementById('remoteVideo');
                var d = document.createElement('div');
                d.className = 'videoContainer';
                d.id = 'container_' + webrtc.getDomId(peer);
                d.appendChild(video);
                video.onclick = function() {
                    video.style.width = video.videWidth + 'px';
                    video.style.height = video.videoHeight + 'px';
                };
                remotes.appendChild(d);
            });

            webrtc.on('videoRemoved', function(video, peer) {
                console.log('video removed', peer);
                var remotes = document.getElementById('remoteVideo');
                var el = document.getElementById('container_' + webrtc.getDomId(peer));
                if (remotes && el) {
                    remotes.removeChild(el);
                }
            });

            $('form').submit(function() {
                var val = $('#sessionInput').val().toLowerCase().replace(/\s\g, '-')
                            .replace(/[^A-Za-z0-9_\-]/g, '');
                webrtc.createRoom(val, function(err, name) {
                    console.log('create roomcb', arguments);

                    var newUrl = location.pathname + '?' + name;
                    if (!err) {
                        history.replaceState({foo: 'bar'}, null, newUrl);
                    } else {
                        console.error(err);
                    }
                })
                return false;
            });
            }
